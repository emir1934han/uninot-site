<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Güvenli Görüntüleyici | UniNot</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* YAZDIRMAYI ENGELLE (CTRL+P yapılsa bile boş sayfa çıkar) */
        @media print {
            body { display: none !important; }
        }

        body {
            background-color: #1e1e1e;
            color: white;
            font-family: 'Outfit', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            user-select: none; /* Yazı seçmeyi engelle */
            -webkit-user-select: none;
        }

        .header {
            width: 100%;
            padding: 15px;
            background: #2d2d2d;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #444;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .btn-close {
            background: #ef4444;
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: bold;
        }

        #pdf-container {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding-bottom: 50px;
            width: 100%;
            align-items: center;
            /* Ekran görüntüsü alındığında bulanıklaşması için CSS filtresi (Bazı tarayıcılarda işe yarar) */
            filter: blur(0px); 
            transition: filter 0.3s;
        }

        canvas {
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            max-width: 100%;
            pointer-events: none; /* Sağ tık menüsünü tuval üzerinde de engelle */
        }
        
        /* Uyarı Mesajı Stili */
        #securityAlert {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: black;
            color: red;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            text-align: center;
        }
        #securityAlert h1 { font-size: 3rem; margin-bottom: 20px; }
    </style>
</head>
<body oncontextmenu="return false;"> <div id="securityAlert">
        <h1>⚠️ GÜVENLİK UYARISI</h1>
        <p>Ekran görüntüsü alma girişimi tespit edildi.</p>
        <p>Bu işlem hesabınızın askıya alınmasına sebep olabilir.</p>
        <button onclick="document.getElementById('securityAlert').style.display='none'" style="padding:10px 20px; font-size:1.2rem; cursor:pointer; margin-top:20px;">Tamam, Anladım</button>
    </div>

    <div class="header">
        <span id="docTitle">Döküman Yükleniyor...</span>
        <button onclick="window.close();" class="btn-close">Kapat</button>
    </div>

    <div id="pdf-container"></div>

    <script type="module">
        import { supabase } from './supabase.js';

        const pdfContainer = document.getElementById('pdf-container');
        const docTitle = document.getElementById('docTitle');
        const securityAlert = document.getElementById('securityAlert');

        // --- GÜVENLİK (Anti-SS) ---
        document.addEventListener('keyup', (e) => {
            if (e.key === 'PrintScreen') {
                navigator.clipboard.writeText('');
                securityAlert.style.display = 'flex';
                setTimeout(() => { securityAlert.style.display = 'none'; }, 3000);
            }
        });
        
        // URL Parametreleri
        const urlParams = new URLSearchParams(window.location.search);
        const noteId = urlParams.get('id');

        if (!noteId) { alert("Hatalı link."); window.close(); }

        async function startViewer() {
            try {
                // 1. Kullanıcı ve Yetki Kontrolü
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) { alert("Giriş yapmalısınız."); window.close(); return; }

                // Not Verisini Çekme
                const { data: note, error } = await supabase.from('notes').select('*').eq('id', noteId).single();
                if (error || !note) throw new Error("Not bulunamadı.");

                docTitle.innerText = note.lesson_name;

                // Satın Alma Kontrolü
                let hasAccess = (note.author_id === user.id);
                if (!hasAccess) {
                    const { data: tx } = await supabase.from('transactions').select('*').eq('buyer_id', user.id).eq('note_id', noteId).single();
                    if (tx) hasAccess = true;
                }
                if (!hasAccess) { alert("Yetkisiz erişim."); window.close(); return; }

                // 2. DOSYA TÜRÜNE GÖRE İŞLEM
                const publicUrl = note.file_url;
                const extension = publicUrl.split('.').pop().toLowerCase();

                // === EĞER PDF İSE (BİZİM GÜVENLİ SİSTEM) ===
                if (extension === 'pdf') {
                    const pathParts = publicUrl.split('/notlar/');
                    const filePath = pathParts[1];

                    const { data: blob, error: dlError } = await supabase.storage.from('notlar').download(filePath);
                    if (dlError) throw dlError;

                    const buffer = await blob.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(buffer).promise;

                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const viewport = page.getViewport({ scale: 1.5 });
                        
                        const canvas = document.createElement('canvas');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        const ctx = canvas.getContext('2d');
                        pdfContainer.appendChild(canvas);
                        
                        await page.render({ canvasContext: ctx, viewport: viewport }).promise;

                        // FİLİGRAN
                        ctx.save();
                        ctx.globalAlpha = 0.15;
                        ctx.textAlign = "center";
                        ctx.textBaseline = "middle";
                        ctx.translate(canvas.width/2, canvas.height/2);
                        ctx.rotate(-45 * Math.PI / 180);
                        ctx.font = "bold 80px Arial"; 
                        ctx.fillStyle = "red";
                        ctx.fillText("UniNot.com", 0, -30); 
                        ctx.font = "bold 30px Arial";
                        ctx.fillStyle = "#333";
                        ctx.fillText(displayName, 0, 40);
                        ctx.restore();
                    }
                } 
                
                // === EĞER OFFICE DOSYASI İSE (WORD, EXCEL, PPT) ===
                else if (['docx', 'doc', 'xlsx', 'xls', 'pptx', 'ppt'].includes(extension)) {
                    // Microsoft Viewer Kullan (iframe içinde)
                    // Not: Bu yöntemde dinamik filigran basılamaz ama dosya görüntülenir.
                    const encodedUrl = encodeURIComponent(publicUrl);
                    const viewerUrl = `https://view.officeapps.live.com/op/embed.aspx?src=${encodedUrl}`;
                    
                    pdfContainer.innerHTML = `
                        <div style="width:100%; height:800px; background:white; padding:10px; border-radius:10px;">
                             <iframe src="${viewerUrl}" width="100%" height="100%" frameborder="0">
                                Bu tarayıcı bu dosyayı görüntüleyemiyor.
                             </iframe>
                             <p style="text-align:center; color:#666; margin-top:10px; font-size:0.9rem;">
                                Not: Word/Excel dosyalarında filigran desteği sınırlıdır.
                             </p>
                        </div>
                    `;
                } 
                
                else {
                    alert("Desteklenmeyen dosya formatı.");
                }

            } catch (err) {
                console.error(err);
                alert("Hata: " + err.message);
            }
        }

        startViewer();
    </script>
</body>
</html>