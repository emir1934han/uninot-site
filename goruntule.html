<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Güvenli Görüntüleyici | UniNot</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    
    <script src="https://unpkg.com/jszip/dist/jszip.min.js"></script>
    <script src="https://unpkg.com/docx-preview/dist/docx-preview.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* YAZDIRMAYI ENGELLE */
        @media print { body { display: none !important; } }

        body {
            background-color: #1e1e1e;
            color: white;
            font-family: 'Outfit', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            user-select: none; /* Yazı seçmeyi engelle */
            -webkit-user-select: none;
            overflow-x: hidden;
        }

        .header {
            width: 100%;
            padding: 15px;
            background: #2d2d2d;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #444;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .btn-close {
            background: #ef4444;
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
        }

        #content-container {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding-bottom: 50px;
            width: 100%;
            align-items: center;
            transition: filter 0.2s;
            position: relative;
        }

        /* PDF Canvas Stili */
        canvas {
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            max-width: 100%;
            pointer-events: none;
        }

        /* WORD Konteyner Stili */
        .docx-wrapper {
            background: white !important; 
            padding: 0 !important;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            width: fit-content;
            margin: 0 auto;
        }
        
        /* docx-preview kütüphanesinin oluşturduğu sayfalar */
        .docx-wrapper section.docx-render {
            margin-bottom: 20px !important; 
            position: relative; /* Filigran için */
        }

        /* Filigran Katmanı (Tüm dökümanın üzerine sabitlenir) */
        #watermark-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 999;
            display: none; /* JS ile açılacak */
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .watermark-text {
            font-size: 80px;
            font-weight: bold;
            color: rgba(255, 0, 0, 0.12); /* Şeffaf Kırmızı */
            transform: rotate(-45deg);
            text-align: center;
            white-space: nowrap;
        }
        .watermark-sub {
            display: block;
            font-size: 30px;
            color: rgba(0, 0, 0, 0.2);
            margin-top: 10px;
        }

        /* Güvenlik Uyarısı Ekranı */
        #securityAlert {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: black;
            color: red;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            text-align: center;
        }
        #securityAlert h1 { font-size: 3rem; margin-bottom: 20px; }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="securityAlert">
        <h1>⚠️ GÜVENLİK UYARISI</h1>
        <p>Ekran görüntüsü alma işlemi engellendi.</p>
    </div>

    <div id="watermark-overlay">
        <div class="watermark-text">
            UniNot.com
            <span class="watermark-sub" id="wm-username">Kullanıcı</span>
        </div>
    </div>

    <div class="header">
        <span id="docTitle">Döküman Yükleniyor...</span>
        <button onclick="window.close()" class="btn-close">Kapat</button>
    </div>

    <div id="content-container"></div>

    <script type="module">
        import { supabase } from './supabase.js';

        const container = document.getElementById('content-container');
        const docTitle = document.getElementById('docTitle');
        const securityAlert = document.getElementById('securityAlert');
        const watermarkOverlay = document.getElementById('watermark-overlay');
        const wmUsername = document.getElementById('wm-username');

        // --- GÜVENLİK (ANTI-SS) ---
        document.addEventListener('keyup', (e) => {
            if (e.key === 'PrintScreen') {
                navigator.clipboard.writeText('');
                securityAlert.style.display = 'flex';
                setTimeout(() => { securityAlert.style.display = 'none'; }, 2000);
            }
        });

        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey && (e.key === 'p' || e.key === 's')) || (e.metaKey && e.shiftKey)) {
                e.preventDefault();
                alert("Korumalı içerik.");
            }
        });

        window.addEventListener('blur', () => { container.style.filter = 'blur(10px)'; });
        window.addEventListener('focus', () => { container.style.filter = 'none'; });


        // --- ANA FONKSİYON ---
        const urlParams = new URLSearchParams(window.location.search);
        const noteId = urlParams.get('id');

        if (!noteId) { alert("Link hatalı."); window.close(); }

        async function startViewer() {
            try {
                // 1. Kullanıcı Kontrolü
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) { alert("Giriş yapın."); window.close(); return; }

                // İsim Bilgisi
                const { data: profile } = await supabase.from('profiles').select('full_name').eq('id', user.id).single();
                const displayName = profile?.full_name ? profile.full_name : user.email;

                // FİLİGRANI GÜNCELLE VE GÖSTER
                wmUsername.innerText = displayName;
                watermarkOverlay.style.display = 'flex'; // Filigranı aç

                // 2. Not Bilgisi
                const { data: note, error } = await supabase.from('notes').select('*').eq('id', noteId).single();
                if (error || !note) throw new Error("Not bulunamadı.");
                docTitle.innerText = note.lesson_name;

                // 3. Yetki Kontrolü
                let hasAccess = (note.author_id === user.id);
                if (!hasAccess) {
                    const { data: tx } = await supabase.from('transactions').select('*').eq('buyer_id', user.id).eq('note_id', noteId).single();
                    if (tx) hasAccess = true;
                }
                if (!hasAccess) { alert("Bu notu satın almalısınız."); window.close(); return; }

                // 4. DOSYAYI İNDİR VE TÜRÜNÜ BELİRLE
                const publicUrl = note.file_url;
                const extension = publicUrl.split('.').pop().toLowerCase();
                const pathParts = publicUrl.split('/notlar/');
                const filePath = pathParts[1];

                // Eğer iframe kullanılmayacaksa dosyayı indir
                if (extension === 'pdf' || extension === 'docx') {
                    const { data: blob, error: dlError } = await supabase.storage.from('notlar').download(filePath);
                    if (dlError) throw dlError;

                    // Blob türünü düzeltmek gerekebilir
                    const cleanBlob = blob.slice(0, blob.size, extension === 'pdf' ? 'application/pdf' : 'application/vnd.openxmlformats-officedocument.wordprocessingml.document');
                    const buffer = await cleanBlob.arrayBuffer();

                    // --- PDF İSE ---
                    if (extension === 'pdf') {
                        // PDF Canvas'ın üzerine CSS filigranı zaten denk geliyor ama 
                        // Canvas içine de basmak istersen eski renderPDF fonksiyonunu kullanabilirsin.
                        // Şimdilik sadece CSS filigranı (sabit duran) yeterliyse bu daha performanslıdır.
                        // Ama senin için Canvas içine basan eski güvenli modu aktif tutuyorum:
                        watermarkOverlay.style.display = 'none'; // Canvas içine basacağız, overlay'i kapa
                        renderPDF(buffer, displayName);
                    } 
                    // --- WORD (.docx) İSE ---
                    else if (extension === 'docx') {
                        renderWord(cleanBlob); // Blob gönderiyoruz
                    }
                } 
                // --- EXCEL/PPT İSE ---
                else {
                    watermarkOverlay.style.display = 'none'; // İframe üstüne basamayız
                    renderOfficeViewer(publicUrl);
                }

            } catch (err) {
                console.error(err);
                alert("Hata: " + err.message);
            }
        }

        // --- PDF RENDER FONKSİYONU ---
        async function renderPDF(buffer, watermarkText) {
            const pdf = await pdfjsLib.getDocument(buffer).promise;
            
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 1.5 });
                
                const canvas = document.createElement('canvas');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                const ctx = canvas.getContext('2d');
                container.appendChild(canvas);
                
                await page.render({ canvasContext: ctx, viewport: viewport }).promise;

                // Canvas Filigranı (Güvenli)
                ctx.save();
                ctx.globalAlpha = 0.15;
                ctx.translate(canvas.width/2, canvas.height/2);
                ctx.rotate(-45 * Math.PI / 180);
                ctx.textAlign = "center";
                
                ctx.font = "bold 80px Arial";
                ctx.fillStyle = "red";
                ctx.fillText("UniNot.com", 0, -30);
                
                ctx.font = "bold 30px Arial";
                ctx.fillStyle = "#333";
                ctx.fillText(watermarkText, 0, 40);
                ctx.restore();
            }
        }

        // --- WORD (.docx) RENDER FONKSİYONU (YENİ VE DÜZGÜN) ---
        async function renderWord(blob) {
            // docx-preview kütüphanesi
            // container elementine render eder
            const options = {
                className: "docx-wrapper", // CSS sınıfı
                inWrapper: true, // Kendi wrapper'ını kullansın mı
                ignoreWidth: false, // Genişliği yoksayma
                ignoreHeight: false, 
                ignoreFonts: false, 
                breakPages: true, // Sayfalara böl
                ignoreLastRenderedPageBreak: false,
                experimental: false,
                trimXmlDeclaration: true,
                useBase64URL: false,
                renderChanges: false,
                debug: false,
            };

            await updateDocx(blob, container, options);
        }

        function updateDocx(blob, target, options) {
            return docx.renderAsync(blob, target, null, options)
                .then(function (x) { console.log("Word render edildi"); });
        }

        // --- DİĞERLERİ İÇİN VIEWER ---
        function renderOfficeViewer(url) {
            const encodedUrl = encodeURIComponent(url);
            container.innerHTML = `
                <iframe src="https://view.officeapps.live.com/op/embed.aspx?src=${encodedUrl}" 
                width="100%" height="800px" frameborder="0"></iframe>
                <p style="color:#aaa;">Bu dosya türü için filigran desteği sınırlıdır.</p>
            `;
        }

        startViewer();
    </script>
</body>
</html>