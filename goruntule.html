<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Güvenli Görüntüleyici | UniNot</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* YAZDIRMAYI ENGELLE */
        @media print { body { display: none !important; } }

        body {
            background-color: #1e1e1e;
            color: white;
            font-family: 'Outfit', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            user-select: none; /* Yazı seçmeyi engelle */
            -webkit-user-select: none;
        }

        .header {
            width: 100%;
            padding: 15px;
            background: #2d2d2d;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #444;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .btn-close {
            background: #ef4444;
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
        }

        #content-container {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding-bottom: 50px;
            width: 100%;
            align-items: center;
            transition: filter 0.2s;
        }

        /* PDF Canvas Stili */
        canvas {
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            max-width: 100%;
            pointer-events: none;
        }

        /* WORD Döküman Stili (Kağıt Görünümü) */
        .word-page {
            background: white;
            color: black;
            width: 21cm; /* A4 Genişliği */
            min-height: 29.7cm;
            padding: 2cm;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            overflow: hidden;
            position: relative; /* Filigran için */
            font-family: 'Times New Roman', serif;
            line-height: 1.5;
        }
        
        /* Word Filigranı (CSS ile) */
        .css-watermark {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 60px;
            font-weight: bold;
            color: rgba(255, 0, 0, 0.15);
            pointer-events: none;
            white-space: nowrap;
            z-index: 10;
            text-align: center;
        }
        .css-watermark-sub {
            display: block;
            font-size: 20px;
            color: rgba(0, 0, 0, 0.2);
            margin-top: 10px;
        }

        /* Güvenlik Uyarısı Ekranı */
        #securityAlert {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: black;
            color: red;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            text-align: center;
        }
        #securityAlert h1 { font-size: 3rem; margin-bottom: 20px; }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="securityAlert">
        <h1>⚠️ GÜVENLİK UYARISI</h1>
        <p>Ekran görüntüsü alma işlemi engellendi.</p>
    </div>

    <div class="header">
        <span id="docTitle">Döküman Yükleniyor...</span>
        <button onclick="window.close()" class="btn-close">Kapat</button>
    </div>

    <div id="content-container"></div>

    <script type="module">
        import { supabase } from './supabase.js';

        const container = document.getElementById('content-container');
        const docTitle = document.getElementById('docTitle');
        const securityAlert = document.getElementById('securityAlert');

        // --- GÜVENLİK (ANTI-SS) ---
        // PrintScreen Tuşu
        document.addEventListener('keyup', (e) => {
            if (e.key === 'PrintScreen') {
                navigator.clipboard.writeText('');
                securityAlert.style.display = 'flex';
                setTimeout(() => { securityAlert.style.display = 'none'; }, 2000);
            }
        });

        // Kısayollar (Ctrl+P, S, Shift+S)
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey && (e.key === 'p' || e.key === 's')) || (e.metaKey && e.shiftKey)) {
                e.preventDefault();
                alert("Korumalı içerik.");
            }
        });

        // Pencere Odaktan Çıkarsa Bulanıklaştır (Opsiyonel Güvenlik)
        window.addEventListener('blur', () => { container.style.filter = 'blur(10px)'; });
        window.addEventListener('focus', () => { container.style.filter = 'none'; });


        // --- ANA FONKSİYON ---
        const urlParams = new URLSearchParams(window.location.search);
        const noteId = urlParams.get('id');

        if (!noteId) { alert("Link hatalı."); window.close(); }

        async function startViewer() {
            try {
                // 1. Kullanıcı Kontrolü
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) { alert("Giriş yapın."); window.close(); return; }

                // İsim Bilgisi
                const { data: profile } = await supabase.from('profiles').select('full_name').eq('id', user.id).single();
                const displayName = profile?.full_name ? profile.full_name : user.email;

                // 2. Not Bilgisi
                const { data: note, error } = await supabase.from('notes').select('*').eq('id', noteId).single();
                if (error || !note) throw new Error("Not bulunamadı.");
                docTitle.innerText = note.lesson_name;

                // 3. Yetki Kontrolü
                let hasAccess = (note.author_id === user.id);
                if (!hasAccess) {
                    const { data: tx } = await supabase.from('transactions').select('*').eq('buyer_id', user.id).eq('note_id', noteId).single();
                    if (tx) hasAccess = true;
                }
                if (!hasAccess) { alert("Bu notu satın almalısınız."); window.close(); return; }

                // 4. DOSYAYI İNDİR VE TÜRÜNÜ BELİRLE
                const publicUrl = note.file_url;
                const extension = publicUrl.split('.').pop().toLowerCase();
                const pathParts = publicUrl.split('/notlar/');
                const filePath = pathParts[1];

                // Eğer iframe kullanılmayacaksa dosyayı indir
                if (extension === 'pdf' || extension === 'docx') {
                    const { data: blob, error: dlError } = await supabase.storage.from('notlar').download(filePath);
                    if (dlError) throw dlError;

                    const buffer = await blob.arrayBuffer();

                    // --- PDF İSE ---
                    if (extension === 'pdf') {
                        renderPDF(buffer, displayName);
                    } 
                    // --- WORD (.docx) İSE ---
                    else if (extension === 'docx') {
                        renderWord(buffer, displayName);
                    }
                } 
                // --- EXCEL/PPT İSE (Hala Microsoft Viewer mecbur) ---
                else {
                    renderOfficeViewer(publicUrl);
                }

            } catch (err) {
                console.error(err);
                alert("Hata: " + err.message);
            }
        }

        // --- PDF RENDER FONKSİYONU ---
        async function renderPDF(buffer, watermarkText) {
            const pdf = await pdfjsLib.getDocument(buffer).promise;
            
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 1.5 });
                
                const canvas = document.createElement('canvas');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                const ctx = canvas.getContext('2d');
                container.appendChild(canvas);
                
                await page.render({ canvasContext: ctx, viewport: viewport }).promise;

                // Canvas Filigranı
                ctx.save();
                ctx.globalAlpha = 0.15;
                ctx.translate(canvas.width/2, canvas.height/2);
                ctx.rotate(-45 * Math.PI / 180);
                ctx.textAlign = "center";
                
                ctx.font = "bold 80px Arial";
                ctx.fillStyle = "red";
                ctx.fillText("UniNot.com", 0, -30);
                
                ctx.font = "bold 30px Arial";
                ctx.fillStyle = "#333";
                ctx.fillText(watermarkText, 0, 40);
                ctx.restore();
            }
        }

        // --- WORD (.docx) RENDER FONKSİYONU (YENİ) ---
        async function renderWord(buffer, watermarkText) {
            // Mammoth.js ile HTML'e çevir
            const result = await mammoth.convertToHtml({ arrayBuffer: buffer });
            
            // Kağıt görünümlü div oluştur
            const pageDiv = document.createElement('div');
            pageDiv.className = 'word-page';
            pageDiv.innerHTML = result.value; // İçeriği bas

            // Filigran Katmanı Ekle
            const watermarkDiv = document.createElement('div');
            watermarkDiv.className = 'css-watermark';
            watermarkDiv.innerHTML = `
                UniNot.com
                <span class="css-watermark-sub">${watermarkText}</span>
            `;

            pageDiv.appendChild(watermarkDiv);
            container.appendChild(pageDiv);
        }

        // --- DİĞERLERİ İÇİN VIEWER ---
        function renderOfficeViewer(url) {
            const encodedUrl = encodeURIComponent(url);
            container.innerHTML = `
                <iframe src="https://view.officeapps.live.com/op/embed.aspx?src=${encodedUrl}" 
                width="100%" height="800px" frameborder="0"></iframe>
                <p style="color:#aaa;">Bu dosya türü için filigran desteği sınırlıdır.</p>
            `;
        }

        startViewer();
    </script>
</body>
</html>