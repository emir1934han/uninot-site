<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Güvenli Görüntüleyici | UniNot</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* YAZDIRMAYI ENGELLE (CTRL+P yapılsa bile boş sayfa çıkar) */
        @media print {
            body { display: none !important; }
        }

        body {
            background-color: #1e1e1e;
            color: white;
            font-family: 'Outfit', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            user-select: none; /* Yazı seçmeyi engelle */
            -webkit-user-select: none;
        }

        .header {
            width: 100%;
            padding: 15px;
            background: #2d2d2d;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #444;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .btn-close {
            background: #ef4444;
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: bold;
        }

        #pdf-container {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding-bottom: 50px;
            width: 100%;
            align-items: center;
            /* Ekran görüntüsü alındığında bulanıklaşması için CSS filtresi (Bazı tarayıcılarda işe yarar) */
            filter: blur(0px); 
            transition: filter 0.3s;
        }

        canvas {
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            max-width: 100%;
            pointer-events: none; /* Sağ tık menüsünü tuval üzerinde de engelle */
        }
        
        /* Uyarı Mesajı Stili */
        #securityAlert {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: black;
            color: red;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            text-align: center;
        }
        #securityAlert h1 { font-size: 3rem; margin-bottom: 20px; }
    </style>
</head>
<body oncontextmenu="return false;"> <div id="securityAlert">
        <h1>⚠️ GÜVENLİK UYARISI</h1>
        <p>Ekran görüntüsü alma girişimi tespit edildi.</p>
        <p>Bu işlem hesabınızın askıya alınmasına sebep olabilir.</p>
        <button onclick="document.getElementById('securityAlert').style.display='none'" style="padding:10px 20px; font-size:1.2rem; cursor:pointer; margin-top:20px;">Tamam, Anladım</button>
    </div>

    <div class="header">
        <span id="docTitle">Döküman Yükleniyor...</span>
        <button onclick="window.close();" class="btn-close">Kapat</button>
    </div>

    <div id="pdf-container"></div>

    <script type="module">
        import { supabase } from './supabase.js';

        const pdfContainer = document.getElementById('pdf-container');
        const docTitle = document.getElementById('docTitle');
        const securityAlert = document.getElementById('securityAlert');

        // --- GÜVENLİK ÖNLEMLERİ (ANTI-SS) ---
        
        // 1. PrintScreen Tuşuna Basılırsa
        document.addEventListener('keyup', (e) => {
            if (e.key === 'PrintScreen') {
                navigator.clipboard.writeText(''); // Panoyu temizle (Kopyalananı sil)
                securityAlert.style.display = 'flex'; // Siyah ekranı aç
                setTimeout(() => { securityAlert.style.display = 'none'; }, 3000); // 3 sn sonra kapat
            }
        });

        // 2. Kısayol Tuşlarını Engelle (Ctrl+P, Ctrl+S, Shift+S)
        document.addEventListener('keydown', (e) => {
            if (
                (e.ctrlKey && e.key === 'p') || // Yazdır
                (e.ctrlKey && e.key === 's') || // Kaydet
                (e.metaKey && e.shiftKey && e.key === '3') || // Mac SS
                (e.metaKey && e.shiftKey && e.key === '4')
            ) {
                e.preventDefault();
                alert("Bu döküman korumalıdır. Kaydetme ve yazdırma yapılamaz.");
            }
        });

        // 3. Pencere Odak Kaybı (Kullanıcı başka programa geçerse - örn: Snipping Tool)
        // Bu özellik çok agresif olabilir, kullanıcı deneyimini bozabilir. 
        // İstersen aşağıdaki yorumu kaldırıp aktif edebilirsin:
        /*
        window.addEventListener('blur', () => {
             pdfContainer.style.filter = 'blur(20px)'; // İçeriği bulanıklaştır
        });
        window.addEventListener('focus', () => {
             pdfContainer.style.filter = 'blur(0px)'; // Geri düzelt
        });
        */


        // --- PDF GÖRÜNTÜLEYİCİ ---

        const urlParams = new URLSearchParams(window.location.search);
        const noteId = urlParams.get('id');

        if (!noteId) {
            alert("Hatalı link.");
            window.close();
        }

        async function startViewer() {
            try {
                // 1. Kullanıcıyı Al
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) { alert("Giriş yapmalısınız."); window.close(); return; }

                // 2. İSİM SOYİSİM ÇEK (YENİ ÖZELLİK)
                const { data: profile } = await supabase
                    .from('profiles')
                    .select('full_name')
                    .eq('id', user.id)
                    .single();
                
                // Eğer isim yoksa E-posta kullan, varsa İsmi kullan
                const displayName = profile?.full_name ? profile.full_name : user.email;

                // 3. Not Bilgisi
                const { data: note, error } = await supabase.from('notes').select('*').eq('id', noteId).single();
                if (error || !note) throw new Error("Not bulunamadı.");

                docTitle.innerText = note.lesson_name;

                // 4. Yetki Kontrolü
                let hasAccess = (note.author_id === user.id);
                if (!hasAccess) {
                    const { data: tx } = await supabase.from('transactions').select('*').eq('buyer_id', user.id).eq('note_id', noteId).single();
                    if (tx) hasAccess = true;
                }
                if (!hasAccess) { alert("Yetkisiz erişim."); window.close(); return; }

                // 5. Dosyayı İndir
                const publicUrl = note.file_url;
                const pathParts = publicUrl.split('/notlar/');
                const filePath = pathParts[1];

                const { data: blob, error: dlError } = await supabase.storage.from('notlar').download(filePath);
                if (dlError) throw dlError;

                const buffer = await blob.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(buffer).promise;

                // 6. Çiz ve Filigran Ekle
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: 1.5 });
                    
                    const canvas = document.createElement('canvas');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    const ctx = canvas.getContext('2d');
                    pdfContainer.appendChild(canvas);
                    
                    await page.render({ canvasContext: ctx, viewport: viewport }).promise;

                    // --- YENİ FİLİGRAN AYARLARI ---
                    ctx.save();
                    ctx.globalAlpha = 0.15; // Şeffaflık ayarı
                    
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";

                    // Tuvalin ortasına git ve çapraz çevir
                    ctx.translate(canvas.width/2, canvas.height/2);
                    ctx.rotate(-45 * Math.PI / 180);

                    // 1. SATIR: SİTE ADI (Büyük)
                    ctx.font = "bold 80px Arial"; 
                    ctx.fillStyle = "red";
                    ctx.fillText("UniNot.com", 0, -30); 
                    
                    // 2. SATIR: KULLANICI ADI (Güvenlik için gerekli, daha küçük)
                 

                    ctx.restore();
                }

            } catch (err) {
                console.error(err);
                alert("Hata oluştu: " + err.message);
            }
        }

        startViewer();
    </script>
</body>
</html>