<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Not SatÄ±n Al | UniNot</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="Anasayfa.css">
</head>
<body>

    <nav class="navbar">
        <div class="container nav-container">
            <div class="logo">
                <i class="fa-solid fa-graduation-cap"></i> UniNot
            </div>
            <ul class="nav-links">
                <li><a href="index.html">Anasayfa</a></li>
                <li><a href="notpaylas.html">Not PaylaÅŸ</a></li> 
                <li><a href="kredilerim.html">Kredilerim</a></li>
                <li><a href="Kayit.html" class="btn-register" id="navAuthBtn">KayÄ±t Ol</a></li>
            </ul>
            <div class="hamburger">
                <i class="fa-solid fa-bars"></i>
            </div>
        </div>
    </nav>

    <header class="page-header">
        <div class="container">
            <h1>AradÄ±ÄŸÄ±n Dersi Bul ðŸ“š</h1>
            <p>GerÃ§ek Ã¶ÄŸrenciler tarafÄ±ndan yÃ¼klenen notlarÄ± keÅŸfet.</p>
            <div class="search-bar">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" id="searchInput" placeholder="Ders adÄ±, Ã¼niversite veya konu ara...">
                <button onclick="searchNotes()">Ara</button>
            </div>
        </div>
    </header>

    <section class="shop-section">
        <div class="container shop-layout">
            
            <aside class="sidebar">
                <div class="filter-group">
                    <h3>Kategoriler</h3>
                    <ul>
                        <li><input type="checkbox" id="cat1"> <label for="cat1">Bilgisayar MÃ¼h.</label></li>
                        <li><input type="checkbox" id="cat2"> <label for="cat2">Hukuk</label></li>
                        <li><input type="checkbox" id="cat3"> <label for="cat3">TÄ±p</label></li>
                        <li><input type="checkbox" id="cat4"> <label for="cat4">Ä°ÅŸletme</label></li>
                    </ul>
                </div>
                <div class="filter-group">
                    <h3>SÄ±ralama</h3>
                    <ul>
                        <li><input type="radio" name="sort" checked> <label>En Yeniler</label></li>
                        <li><input type="radio" name="sort"> <label>En Ã‡ok Ä°ndirilenler</label></li>
                    </ul>
                </div>
            </aside>

            <main class="notes-grid" id="notesContainer">
                <div style="grid-column: 1/-1; text-align: center; padding: 50px; color: #666;">
                    <i class="fa-solid fa-spinner fa-spin" style="font-size: 2rem;"></i>
                    <p>Notlar yÃ¼kleniyor...</p>
                </div>
            </main>
        </div>
    </section>

    <footer>
        <div class="container footer-content">
            <div class="footer-brand">
                <h2>UniNot</h2>
                <p>Ã–ÄŸrencilerin dijital kÃ¼tÃ¼phanesi.</p>
            </div>
            <div class="copyright">
                <p>&copy; 2025 UniNot.</p>
            </div>
        </div>
    </footer>

    <script src="script.js"></script>

    <script type="module">
        import { supabase } from './supabase.js';

        const notesContainer = document.getElementById('notesContainer');
        const navAuthBtn = document.getElementById('navAuthBtn');
        let currentUser = null;

        // 1. KullanÄ±cÄ± GiriÅŸ KontrolÃ¼
        async function checkUser() {
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                currentUser = user;
                navAuthBtn.innerText = "HesabÄ±m";
                navAuthBtn.href = "kredilerim.html";
            }
        }
        checkUser();

        // 2. NotlarÄ± VeritabanÄ±ndan Ã‡ek
        async function fetchNotes(searchTerm = "") {
            
            // VeritabanÄ±ndan notlarÄ± Ã§ek (Tarihe gÃ¶re yeniden eskiye)
            let query = supabase
                .from('notes')
                .select('*')
                .order('created_at', { ascending: false });

            // Arama varsa filtrele
            if (searchTerm) {
                query = query.ilike('lesson_name', `%${searchTerm}%`);
            }

            const { data: notes, error } = await query;

            if (error) {
                console.error("Notlar Ã§ekilirken hata:", error);
                notesContainer.innerHTML = `<p style="color:red; text-align:center;">Hata oluÅŸtu: ${error.message}</p>`;
                return;
            }

            renderNotes(notes);
        }

        // 3. NotlarÄ± Ekrana Bas (Kart OluÅŸturma)
        function renderNotes(notes) {
            notesContainer.innerHTML = ""; // YÃ¼kleniyor yazÄ±sÄ±nÄ± sil

            if (!notes || notes.length === 0) {
                notesContainer.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; background: white; border-radius: 10px;">
                        <i class="fa-regular fa-folder-open" style="font-size: 3rem; color: #cbd5e1; margin-bottom:10px;"></i>
                        <h3>HenÃ¼z not yÃ¼klenmemiÅŸ.</h3>
                        <p>Ä°lk notu sen paylaÅŸmak ister misin?</p>
                        <a href="notpaylas.html" class="btn-buy" style="display:inline-block; margin-top:10px; width:auto;">Not PaylaÅŸ</a>
                    </div>`;
                return;
            }

            notes.forEach(note => {
                // Rastgele renk sÄ±nÄ±fÄ± seÃ§
                const colors = ['', 'color-blue', 'color-green', 'color-purple'];
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                
                // Notun sahibi bakan kiÅŸi mi?
                const isOwner = currentUser && (note.author_id === currentUser.id);
                
                // Fiyat etiketi
                const priceText = note.price == 0 ? 'Ãœcretsiz' : `${note.price} â‚º`;
                
                // Buton Metni
                let buttonText = "SatÄ±n Al ve Ä°ndir";
                if (isOwner) buttonText = "Kendi Notun (Ä°ndir)";
                else if (note.price == 0) buttonText = "Ãœcretsiz Ä°ndir";

                const cardHTML = `
                <div class="note-card">
                    <div class="card-image ${randomColor}">
                        <span class="badge-price">${priceText}</span>
                        <i class="fa-regular fa-file-pdf"></i>
                    </div>
                    <div class="card-body">
                        <div class="university">${note.university || 'Genel'}</div>
                        <h3 title="${note.lesson_name}">${note.lesson_name}</h3>
                        <div class="author">
                            <i class="fa-solid fa-user-pen"></i> ${note.category || 'DiÄŸer'}
                        </div>
                        <p style="font-size: 0.85rem; color: #64748b; margin-bottom: 15px; min-height: 40px;">
                            ${note.description ? note.description.substring(0, 60) + '...' : 'AÃ§Ä±klama yok.'}
                        </p>
                        
                        <button onclick="window.triggerPurchase(${note.id})" class="btn-buy" style="width:100%; border:none; cursor:pointer;">
                            ${buttonText}
                        </button>
                    </div>
                </div>
                `;
                notesContainer.innerHTML += cardHTML;
            });
        }

        // Sayfa aÃ§Ä±lÄ±nca notlarÄ± getir
        fetchNotes();

        // Arama Fonksiyonu
        window.searchNotes = function() {
            const val = document.getElementById('searchInput').value;
            notesContainer.innerHTML = '<p style="text-align:center;">AranÄ±yor...</p>';
            fetchNotes(val);
        }

        // --- SATIN ALMA / Ä°NDÄ°RME FONKSÄ°YONU ---
        window.triggerPurchase = async function(noteId) {
            // 1. GiriÅŸ kontrolÃ¼
            if (!currentUser) {
                if(confirm("Bu notu indirmek iÃ§in giriÅŸ yapmalÄ±sÄ±nÄ±z. GiriÅŸ sayfasÄ±na gidilsin mi?")) {
                    window.location.href = "Kayit.html";
                }
                return;
            }

            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "Ä°ÅŸleniyor...";
            btn.disabled = true;

            try {
                // 2. Supabase VeritabanÄ± Fonksiyonunu (RPC) Ã‡aÄŸÄ±r
                const { data, error } = await supabase.rpc('buy_note', {
                    note_row_id: noteId,
                    client_id: currentUser.id
                });

                if (error) throw error;

                // 3. Sonuca Bak
                if (data.success) {
                    // BaÅŸarÄ±lÄ±!
                    alert(data.message); 
                    // Linki yeni sekmede aÃ§
                    window.open(data.download_url, '_blank');
                } else {
                    // BaÅŸarÄ±sÄ±z (Yetersiz bakiye vb.)
                    alert("UyarÄ±: " + data.message);
                }

            } catch (err) {
                console.error("SatÄ±n alma hatasÄ±:", err);
                alert("Bir hata oluÅŸtu: " + err.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>