<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Not SatÄ±n Al | UniNot</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="Anasayfa.css">
    
    <style>
        /* --- Sidebar & Arama Stilleri --- */
        .filter-group { margin-bottom: 25px; position: relative; }
        
        /* Dropdown Input TasarÄ±mÄ± */
        .search-dropdown input {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: 0.3s;
        }
        .search-dropdown input:focus {
            border-color: #4f46e5;
            outline: none;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        /* AÃ§Ä±lÄ±r Liste Kutusu */
        .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 100;
            display: none; /* Gizli */
        }
        .dropdown-list.show { display: block; }

        .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.85rem;
            border-bottom: 1px solid #f1f5f9;
        }
        .dropdown-item:hover { background: #f8fafc; color: #4f46e5; }

        /* Yazar Ä°smi ve Kart DÃ¼zeni */
        .author-badge {
            font-size: 0.85rem; 
            color: #475569; 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            margin-bottom: 8px;
            font-weight: 500;
        }

        /* AÃ§Ä±klama AlanÄ± */
        .desc-container {
            font-size: 0.85rem;
            color: #64748b;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        .desc-full { display: none; } /* Uzun metin baÅŸta gizli */
        .read-more-btn {
            color: #4f46e5;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.8rem;
            text-decoration: none;
            display: inline-block;
            margin-top: 2px;
        }
        .read-more-btn:hover { text-decoration: underline; }

    </style>
</head>
<body>

    <nav class="navbar">
        <div class="container nav-container">
            <div class="logo"><i class="fa-solid fa-graduation-cap"></i> UniNot</div>
            <ul class="nav-links">
                <li><a href="index.html">Anasayfa</a></li>
                <li><a href="notpaylas.html">Not PaylaÅŸ</a></li> 
                <li><a href="kredilerim.html">Kredilerim</a></li>
                <li><a href="Kayit.html" class="btn-register" id="navAuthBtn">KayÄ±t Ol</a></li>
            </ul>
            <div class="hamburger"><i class="fa-solid fa-bars"></i></div>
        </div>
    </nav>

    <header class="page-header">
        <div class="container">
            <h1>AradÄ±ÄŸÄ±n Dersi Bul ðŸ“š</h1>
            <p>GerÃ§ek Ã¶ÄŸrenciler tarafÄ±ndan yÃ¼klenen notlarÄ± keÅŸfet.</p>
            <div class="search-bar">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" id="searchInput" placeholder="Ders adÄ±, hoca adÄ± veya konu ara..." onkeyup="applyFilters()">
                <button onclick="applyFilters()">Ara</button>
            </div>
        </div>
    </header>

    <section class="shop-section">
        <div class="container shop-layout">
            
            <aside class="sidebar">
                <div class="filter-group">
                    <h3>Ãœniversite</h3>
                    <div class="search-dropdown">
                        <input type="text" id="uniFilterInput" placeholder="Ãœniversite yaz..." autocomplete="off">
                        <div id="uniList" class="dropdown-list"></div>
                    </div>
                </div>

                <div class="filter-group">
                    <h3>BÃ¶lÃ¼m / Kategori</h3>
                    <div class="search-dropdown">
                        <input type="text" id="deptFilterInput" placeholder="BÃ¶lÃ¼m yaz..." autocomplete="off">
                        <div id="deptList" class="dropdown-list"></div>
                    </div>
                </div>

                <div class="filter-group">
                    <h3>SÄ±ralama</h3>
                    <ul>
                        <li><input type="radio" name="sort" value="newest" checked onchange="applyFilters()"> <label>En Yeniler</label></li>
                        <li><input type="radio" name="sort" value="popular" onchange="applyFilters()"> <label>En Ã‡ok Ä°ndirilenler</label></li>
                        <li><input type="radio" name="sort" value="cheap" onchange="applyFilters()"> <label>Fiyata GÃ¶re (Artan)</label></li>
                    </ul>
                </div>
                
                <button onclick="clearFilters()" style="width:100%; padding:10px; background:#e2e8f0; border:none; border-radius:8px; cursor:pointer; font-weight:600; color:#475569;">Filtreleri Temizle</button>
            </aside>

            <main class="notes-grid" id="notesContainer">
                <div style="grid-column: 1/-1; text-align: center; padding: 50px; color:#666;">
                    <i class="fa-solid fa-spinner fa-spin" style="font-size:2rem; margin-bottom:10px;"></i>
                    <p>Notlar yÃ¼kleniyor...</p>
                </div>
            </main>
        </div>
    </section>

    <footer>
        <div class="container footer-content">
            <div class="footer-brand"><h2>UniNot</h2><p>Ã–ÄŸrencilerin dijital kÃ¼tÃ¼phanesi.</p></div>
        </div>
        <div class="copyright"><p>&copy; 2025 UniNot.</p></div>
    </footer>

    <script src="script.js"></script>

   <script type="module">
        import { supabase } from './supabase.js';

        // --- VERÄ° LÄ°STELERÄ° ---
        const universities = [
            "Akdeniz Ãœniversitesi", "Anadolu Ãœniversitesi", "Ankara Ãœniversitesi", "AtatÃ¼rk Ãœniversitesi",
            "BoÄŸaziÃ§i Ãœniversitesi", "Bursa UludaÄŸ Ãœniversitesi", "Ã‡ukurova Ãœniversitesi", "Dokuz EylÃ¼l Ãœniversitesi",
            "Ege Ãœniversitesi", "Erciyes Ãœniversitesi", "Galatasaray Ãœniversitesi", "Gazi Ãœniversitesi",
            "Hacettepe Ãœniversitesi", "Ä°stanbul Teknik Ãœniversitesi", "Ä°stanbul Ãœniversitesi",
            "Ä°zmir YÃ¼ksek Teknoloji EnstitÃ¼sÃ¼", "KoÃ§ Ãœniversitesi", "Marmara Ãœniversitesi",
            "Mehmet Akif Ersoy Ãœniversitesi", "Orta DoÄŸu Teknik Ãœniversitesi", "SabancÄ± Ãœniversitesi",
            "Sakarya Ãœniversitesi", "SelÃ§uk Ãœniversitesi", "YÄ±ldÄ±z Teknik Ãœniversitesi"
        ];

        const departments = [
            "Bilgisayar MÃ¼hendisliÄŸi", "DiÅŸ HekimliÄŸi", "EczacÄ±lÄ±k", "Elektrik-Elektronik MÃ¼hendisliÄŸi",
            "EndÃ¼stri MÃ¼hendisliÄŸi", "Hukuk", "Ä°Ã§ MimarlÄ±k", "Ä°ktisat", "Ä°lahiyat", "Ä°ngilizce Ã–ÄŸretmenliÄŸi",
            "Ä°nÅŸaat MÃ¼hendisliÄŸi", "Ä°ÅŸletme", "Makine MÃ¼hendisliÄŸi", "MimarlÄ±k", "Psikoloji",
            "SÄ±nÄ±f Ã–ÄŸretmenliÄŸi", "Siyaset Bilimi", "TÄ±p", "YazÄ±lÄ±m MÃ¼hendisliÄŸi", "YÃ¶netim BiliÅŸim Sistemleri"
        ];

        // Listeleri SÄ±rala
        universities.sort((a, b) => a.localeCompare(b, 'tr'));
        departments.sort((a, b) => a.localeCompare(b, 'tr'));

        // --- DROPDOWN AYARLARI ---
        function setupFilterDropdown(inputId, listId, dataArray) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(listId);

            input.addEventListener('input', () => {
                const val = input.value.toLocaleLowerCase('tr');
                list.innerHTML = '';
                applyFilters(); // Yazarken filtrele

                if (!val) {
                    list.classList.remove('show');
                    return;
                }

                const filtered = dataArray.filter(item => item.toLocaleLowerCase('tr').includes(val));
                
                if (filtered.length > 0) {
                    filtered.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'dropdown-item';
                        div.textContent = item;
                        div.addEventListener('click', () => {
                            input.value = item;
                            list.classList.remove('show');
                            applyFilters();
                        });
                        list.appendChild(div);
                    });
                    list.classList.add('show');
                } else {
                    list.classList.remove('show');
                }
            });

            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !list.contains(e.target)) {
                    list.classList.remove('show');
                }
            });
        }

        setupFilterDropdown('uniFilterInput', 'uniList', universities);
        setupFilterDropdown('deptFilterInput', 'deptList', departments);

        // --- ANA Ä°ÅžLEMLER ---
        const notesContainer = document.getElementById('notesContainer');
        const navAuthBtn = document.getElementById('navAuthBtn');
        let currentUser = null;
        let myPurchasedNoteIds = [];

        async function init() {
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                currentUser = user;
                navAuthBtn.innerText = "HesabÄ±m";
                navAuthBtn.href = "kredilerim.html";

                const { data: transactions } = await supabase
                    .from('transactions')
                    .select('note_id')
                    .eq('buyer_id', user.id);
                
                if (transactions) myPurchasedNoteIds = transactions.map(t => t.note_id);
            }
            applyFilters();
        }
        init();

        // --- FÄ°LTRELEME VE VERÄ° Ã‡EKME ---
        window.applyFilters = async function() {
            const searchVal = document.getElementById('searchInput').value;
            const uniVal = document.getElementById('uniFilterInput').value;
            const deptVal = document.getElementById('deptFilterInput').value;
            const sortVal = document.querySelector('input[name="sort"]:checked').value;

            // NotlarÄ± Ã‡ekme Sorgusu
            // NOT: EÄŸer profil Ã§ekme hata verirse, sadece notlarÄ± Ã§ekip hatayÄ± yok saymayÄ± deneyebiliriz.
            let query = supabase
                .from('notes')
                .select('*, profiles(full_name)'); // Basit iliÅŸki yapÄ±sÄ±

            if (searchVal) query = query.ilike('lesson_name', `%${searchVal}%`);
            if (uniVal) query = query.ilike('university', `%${uniVal}%`);
            if (deptVal) query = query.ilike('category', `%${deptVal}%`);

            if (sortVal === 'newest') query = query.order('created_at', { ascending: false });
            else if (sortVal === 'popular') query = query.order('sales_count', { ascending: false });
            else if (sortVal === 'cheap') query = query.order('price', { ascending: true });

            const { data: notes, error } = await query;

            // HATA YAKALAMA (Ekrana YazdÄ±rma)
            if (error) {
                console.error("Supabase HatasÄ±:", error);
                
                // EÄŸer hata "Ä°liÅŸki bulunamadÄ±" ise kullanÄ±cÄ±ya Ã¶zel mesaj gÃ¶ster
                let errorMsg = error.message;
                let hint = "";
                
                if(error.code === "PGRST200") {
                    hint = "Ä°pucu: VeritabanÄ±nda 'notes' ve 'profiles' tablolarÄ± arasÄ±ndaki iliÅŸki kurulamamÄ±ÅŸ. SQL Editor'den iliÅŸki kodunu tekrar Ã§alÄ±ÅŸtÄ±rÄ±n.";
                } else if (error.code === "42501") {
                    hint = "Ä°pucu: Profil tablosunu okuma izniniz yok. RLS (Security) ayarlarÄ±ndan 'Herkes profilleri gÃ¶rebilir' iznini aÃ§Ä±n.";
                }

                notesContainer.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #dc2626; background: #fef2f2; border: 1px solid #fee2e2; border-radius: 10px;">
                        <i class="fa-solid fa-circle-exclamation" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <h3>Veriler YÃ¼klenemedi</h3>
                        <p><b>Hata:</b> ${errorMsg}</p>
                        <p><b>Kod:</b> ${error.code || 'Yok'}</p>
                        <p style="font-size: 0.9rem; margin-top: 10px; color: #666;">${hint}</p>
                    </div>`;
                return;
            }

            renderNotes(notes);
        }

        function renderNotes(notes) {
            notesContainer.innerHTML = "";

            if (!notes || notes.length === 0) {
                notesContainer.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:30px; color:#666;">AradÄ±ÄŸÄ±nÄ±z kriterde not bulunamadÄ±.</div>';
                return;
            }

            notes.forEach(note => {
                const colors = ['', 'color-blue', 'color-green', 'color-purple'];
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                
                const isOwner = currentUser && (note.author_id === currentUser.id);
                const isPurchased = myPurchasedNoteIds.includes(note.id);
                
                // Yazar Ä°smi KontrolÃ¼
                let authorName = "Anonim";
                if (note.profiles && note.profiles.full_name) {
                    authorName = note.profiles.full_name;
                } else if (note.author_email) {
                    authorName = note.author_email.split('@')[0];
                }

                // AÃ§Ä±klama KÄ±saltma
                const fullDesc = note.description || "AÃ§Ä±klama girilmemiÅŸ.";
                const shortDesc = fullDesc.length > 80 ? fullDesc.substring(0, 80) + "..." : fullDesc;
                const hasMore = fullDesc.length > 80;

                // Buton Metni
                let btnText = `SatÄ±n Al (${note.price}â‚º)`;
                let btnStyle = "";
                if (isOwner) { btnText = "Senin Notun (GÃ¶rÃ¼ntÃ¼le)"; btnStyle = "background:#64748b;"; }
                else if (isPurchased) { btnText = "SatÄ±n AlÄ±ndÄ± (GÃ¶rÃ¼ntÃ¼le)"; btnStyle = "background:#16a34a;"; }
                else if (note.price == 0) { btnText = "Ãœcretsiz GÃ¶rÃ¼ntÃ¼le"; }

                const cardHTML = `
                <div class="note-card">
                    <div class="card-image ${randomColor}">
                        <span class="badge-price">${note.price == 0 ? 'Ãœcretsiz' : note.price + 'â‚º'}</span>
                        <i class="fa-regular fa-file-pdf"></i>
                    </div>
                    <div class="card-body">
                        <div class="university">${note.university || 'Genel'}</div>
                        <h3 title="${note.lesson_name}">${note.lesson_name}</h3>
                        
                        <div class="author-badge">
                            <i class="fa-solid fa-user-pen"></i> ${authorName}
                        </div>
                        
                        <div class="rating">
                            <i class="fa-solid fa-eye"></i> ${note.sales_count || 0} GÃ¶rÃ¼ntÃ¼lenme
                        </div>
                        
                        <div class="desc-container">
                            <span class="desc-short" id="short-${note.id}">${shortDesc}</span>
                            <span class="desc-full" id="full-${note.id}">${fullDesc}</span>
                            ${hasMore ? `<a class="read-more-btn" onclick="toggleDesc(${note.id})">DevamÄ±nÄ± Oku</a>` : ''}
                        </div>

                        <button onclick="window.handleNoteAction(${note.id}, '${note.file_url}', ${isOwner}, ${isPurchased})" 
                            class="btn-buy" style="width:100%; border:none; cursor:pointer; ${btnStyle}">
                            ${btnText}
                        </button>
                    </div>
                </div>
                `;
                notesContainer.innerHTML += cardHTML;
            });
        }

        // AÃ§Ä±klama AÃ§/Kapa
        window.toggleDesc = function(id) {
            const shortSpan = document.getElementById(`short-${id}`);
            const fullSpan = document.getElementById(`full-${id}`);
            const btn = event.target;

            if (fullSpan.style.display === "inline") {
                fullSpan.style.display = "none";
                shortSpan.style.display = "inline";
                btn.innerText = "DevamÄ±nÄ± Oku";
            } else {
                fullSpan.style.display = "inline";
                shortSpan.style.display = "none";
                btn.innerText = "Gizle";
            }
        }

        // --- SATIN ALMA / GÃ–RÃœNTÃœLEME Ä°ÅžLEMÄ° ---
        window.handleNoteAction = async function(noteId, fileUrl, isOwner, isPurchased) {
            if (!currentUser) {
                if(confirm("Ä°ÅŸlem yapmak iÃ§in giriÅŸ yapmalÄ±sÄ±nÄ±z. KayÄ±t sayfasÄ±na gidilsin mi?")) 
                    window.location.href = "Kayit.html";
                return;
            }

            // Zaten alÄ±nmÄ±ÅŸsa -> goruntule.html sayfasÄ±na git
            if (isOwner || isPurchased) {
                window.location.href = `goruntule.html?id=${noteId}`;
                return;
            }

            if(!confirm("Bu notu satÄ±n almak istediÄŸinize emin misiniz?")) return;

            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "Ä°ÅŸleniyor..."; 
            btn.disabled = true;

            try {
                const { data, error } = await supabase.rpc('buy_note', {
                    note_row_id: noteId, client_id: currentUser.id
                });

                if (error) throw error;

                if (data.success) {
                    alert(data.message);
                    myPurchasedNoteIds.push(noteId);
                    // BaÅŸarÄ±lÄ± olunca gÃ¶rÃ¼ntÃ¼leme sayfasÄ±na gÃ¶nder
                    window.location.href = `goruntule.html?id=${noteId}`;
                } else {
                    alert("Hata: " + data.message);
                    btn.innerText = originalText; 
                    btn.disabled = false;
                }
            } catch (err) {
                alert("Hata: " + err.message);
                btn.innerText = originalText; 
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>