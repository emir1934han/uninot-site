<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Not SatÄ±n Al | UniNot</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="Anasayfa.css">
    
    <style>
        /* Sidebar iÃ§in ek stil */
        .filter-group input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .author-badge {
            font-size: 0.8rem; color: #666; display: flex; align-items: center; gap: 5px; margin-bottom: 5px;
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="container nav-container">
            <div class="logo"><i class="fa-solid fa-graduation-cap"></i> UniNot</div>
            <ul class="nav-links">
                <li><a href="index.html">Anasayfa</a></li>
                <li><a href="notpaylas.html">Not PaylaÅŸ</a></li> 
                <li><a href="kredilerim.html">Kredilerim</a></li>
                <li><a href="Kayit.html" class="btn-register" id="navAuthBtn">KayÄ±t Ol</a></li>
            </ul>
        </div>
    </nav>

    <header class="page-header">
        <div class="container">
            <h1>AradÄ±ÄŸÄ±n Dersi Bul ðŸ“š</h1>
            <p>GerÃ§ek Ã¶ÄŸrenciler tarafÄ±ndan yÃ¼klenen notlarÄ± keÅŸfet.</p>
            <div class="search-bar">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" id="searchInput" placeholder="Ders adÄ± ara..." onkeyup="applyFilters()">
                <button onclick="applyFilters()">Ara</button>
            </div>
        </div>
    </header>

    <section class="shop-section">
        <div class="container shop-layout">
            
            <aside class="sidebar">
                <div class="filter-group">
                    <h3>Ãœniversite</h3>
                    <input type="text" id="uniFilter" placeholder="Ã–rn: ODTÃœ" oninput="applyFilters()">
                </div>

                <div class="filter-group">
                    <h3>BÃ¶lÃ¼mler</h3>
                    <ul>
                        <li><input type="checkbox" class="cat-filter" value="Bilgisayar MÃ¼hendisliÄŸi" onchange="applyFilters()"> <label>Bilgisayar MÃ¼h.</label></li>
                        <li><input type="checkbox" class="cat-filter" value="Hukuk" onchange="applyFilters()"> <label>Hukuk</label></li>
                        <li><input type="checkbox" class="cat-filter" value="TÄ±p" onchange="applyFilters()"> <label>TÄ±p</label></li>
                        <li><input type="checkbox" class="cat-filter" value="Ä°ÅŸletme" onchange="applyFilters()"> <label>Ä°ÅŸletme</label></li>
                        <li><input type="checkbox" class="cat-filter" value="MimarlÄ±k" onchange="applyFilters()"> <label>MimarlÄ±k</label></li>
                    </ul>
                </div>

                <div class="filter-group">
                    <h3>SÄ±ralama</h3>
                    <ul>
                        <li><input type="radio" name="sort" value="newest" checked onchange="applyFilters()"> <label>En Yeniler</label></li>
                        <li><input type="radio" name="sort" value="popular" onchange="applyFilters()"> <label>En Ã‡ok Ä°ndirilenler</label></li>
                        <li><input type="radio" name="sort" value="cheap" onchange="applyFilters()"> <label>Fiyata GÃ¶re (Artan)</label></li>
                    </ul>
                </div>
            </aside>

            <main class="notes-grid" id="notesContainer">
                <div style="grid-column: 1/-1; text-align: center; padding: 50px;">
                    <i class="fa-solid fa-spinner fa-spin"></i> Notlar yÃ¼kleniyor...
                </div>
            </main>
        </div>
    </section>

    <footer>
        <div class="container footer-content">
            <div class="footer-brand"><h2>UniNot</h2><p>Ã–ÄŸrencilerin dijital kÃ¼tÃ¼phanesi.</p></div>
        </div>
        <div class="copyright"><p>&copy; 2025 UniNot.</p></div>
    </footer>

    <script src="script.js"></script>

    <script type="module">
        import { supabase } from './supabase.js';

        const notesContainer = document.getElementById('notesContainer');
        const navAuthBtn = document.getElementById('navAuthBtn');
        
        let currentUser = null;
        let myPurchasedNoteIds = []; // SatÄ±n aldÄ±ÄŸÄ±m notlarÄ±n ID listesi

        // 1. KullanÄ±cÄ±yÄ± ve SatÄ±n AldÄ±klarÄ±nÄ± Ã‡ek
        async function init() {
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                currentUser = user;
                navAuthBtn.innerText = "HesabÄ±m";
                navAuthBtn.href = "kredilerim.html";

                // KullanÄ±cÄ±nÄ±n daha Ã¶nce satÄ±n aldÄ±ÄŸÄ± notlarÄ±n ID'lerini Ã§ek
                const { data: transactions } = await supabase
                    .from('transactions')
                    .select('note_id')
                    .eq('buyer_id', user.id);
                
                if (transactions) {
                    myPurchasedNoteIds = transactions.map(t => t.note_id);
                }
            }
            applyFilters(); // NotlarÄ± getir
        }
        init();

        // 2. Filtreleme ve NotlarÄ± Getirme
        window.applyFilters = async function() {
            notesContainer.innerHTML = '<p style="text-align:center;">YÃ¼kleniyor...</p>';

            const searchVal = document.getElementById('searchInput').value;
            const uniVal = document.getElementById('uniFilter').value;
            
            // SeÃ§ili kategorileri bul
            const checkedCats = Array.from(document.querySelectorAll('.cat-filter:checked')).map(cb => cb.value);
            
            // SÄ±ralama seÃ§imi
            const sortVal = document.querySelector('input[name="sort"]:checked').value;

            // Sorguyu HazÄ±rla
            let query = supabase.from('notes').select('*');

            if (searchVal) query = query.ilike('lesson_name', `%${searchVal}%`);
            if (uniVal) query = query.ilike('university', `%${uniVal}%`);
            if (checkedCats.length > 0) query = query.in('category', checkedCats);

            // SÄ±ralama MantÄ±ÄŸÄ±
            if (sortVal === 'newest') query = query.order('created_at', { ascending: false });
            else if (sortVal === 'popular') query = query.order('sales_count', { ascending: false });
            else if (sortVal === 'cheap') query = query.order('price', { ascending: true });

            const { data: notes, error } = await query;

            if (error) {
                console.error(error);
                notesContainer.innerHTML = "Hata oluÅŸtu.";
                return;
            }
            renderNotes(notes);
        }

        // 3. Ekrana Basma
        function renderNotes(notes) {
            notesContainer.innerHTML = "";

            if (!notes || notes.length === 0) {
                notesContainer.innerHTML = '<p style="text-align:center; grid-column:1/-1;">AradÄ±ÄŸÄ±nÄ±z kriterde not bulunamadÄ±.</p>';
                return;
            }

            notes.forEach(note => {
                const colors = ['', 'color-blue', 'color-green', 'color-purple'];
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                
                // KONTROLLER
                const isOwner = currentUser && (note.author_id === currentUser.id);
                const isPurchased = myPurchasedNoteIds.includes(note.id); // Daha Ã¶nce almÄ±ÅŸ mÄ±?
                
                // BUTON DURUMU BELÄ°RLEME
                let btnText = `SatÄ±n Al (${note.price}â‚º)`;
                let btnClass = "btn-buy";
                let btnStyle = "";

                if (isOwner) {
                    btnText = "Senin Notun (Ä°ndir)";
                    btnStyle = "background:#64748b; color:white;";
                } else if (isPurchased) {
                    btnText = "SatÄ±n AlÄ±ndÄ± (Ä°ndir)";
                    btnStyle = "background:#16a34a; color:white;"; // YeÅŸil
                } else if (note.price == 0) {
                    btnText = "Ãœcretsiz Ä°ndir";
                }

                // Yazar bilgisi (Emailin baÅŸÄ±)
                const authorName = note.author_email ? note.author_email.split('@')[0] : 'Anonim';

                const cardHTML = `
                <div class="note-card">
                    <div class="card-image ${randomColor}">
                        <span class="badge-price">${note.price == 0 ? 'Ãœcretsiz' : note.price + 'â‚º'}</span>
                        <i class="fa-regular fa-file-pdf"></i>
                    </div>
                    <div class="card-body">
                        <div class="university">${note.university || 'Genel'}</div>
                        <h3 title="${note.lesson_name}">${note.lesson_name}</h3>
                        
                        <div class="author-badge">
                            <i class="fa-solid fa-user"></i> ${authorName}
                        </div>
                        <div class="rating">
                            <i class="fa-solid fa-download"></i> ${note.sales_count || 0} Ä°ndirme
                        </div>
                        
                        <p style="font-size:0.8rem; color:#666; margin-bottom:10px;">${note.description ? note.description.substring(0,50)+'...' : ''}</p>

                        <button onclick="window.handleNoteAction(${note.id}, '${note.file_url}', ${isOwner}, ${isPurchased})" 
                            class="${btnClass}" style="width:100%; cursor:pointer; border:none; ${btnStyle}">
                            ${btnText}
                        </button>
                    </div>
                </div>
                `;
                notesContainer.innerHTML += cardHTML;
            });
        }

        // 4. BUTON AKSÄ°YONU (SatÄ±n Al veya Direkt Ä°ndir)
        window.handleNoteAction = async function(noteId, fileUrl, isOwner, isPurchased) {
            if (!currentUser) {
                alert("Ä°ÅŸlem yapmak iÃ§in giriÅŸ yapmalÄ±sÄ±nÄ±z.");
                window.location.href = "Kayit.html";
                return;
            }

            // EÄŸer not zaten benimse veya satÄ±n aldÄ±ysam, direkt aÃ§ (Para Ã§ekme!)
            if (isOwner || isPurchased) {
                window.open(fileUrl, '_blank');
                return;
            }

            // DeÄŸilse, SatÄ±n Alma Fonksiyonunu Ã‡aÄŸÄ±r
            if(!confirm("Bu notu satÄ±n almak istediÄŸinize emin misiniz?")) return;

            // Butonu bulup 'Ä°ÅŸleniyor' yapalÄ±m (BasitÃ§e)
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "Ä°ÅŸleniyor...";
            btn.disabled = true;

            try {
                const { data, error } = await supabase.rpc('buy_note', {
                    note_row_id: noteId,
                    client_id: currentUser.id
                });

                if (error) throw error;

                if (data.success) {
                    alert(data.message);
                    // BaÅŸarÄ±lÄ± olunca listeyi yenile (Buton yeÅŸile dÃ¶nsÃ¼n diye)
                    // Ve anlÄ±k olarak satÄ±n alÄ±nanlar listesine ekle
                    myPurchasedNoteIds.push(noteId);
                    
                    window.open(data.download_url, '_blank');
                    applyFilters(); // ArayÃ¼zÃ¼ gÃ¼ncelle
                } else {
                    alert("Hata: " + data.message);
                }
            } catch (err) {
                alert("Ä°ÅŸlem hatasÄ±: " + err.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>