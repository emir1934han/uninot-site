<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kredilerim | UniNot</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="Anasayfa.css">
    <link rel="stylesheet" href="Kredilerim.css">
</head>
<body>

    <nav class="navbar">
        <div class="container nav-container">
            <div class="logo">
                <i class="fa-solid fa-graduation-cap"></i> UniNot
            </div>
            <ul class="nav-links">
                <li><a href="index.html">Anasayfa</a></li>
                <li><a href="not-al.html">Not SatÄ±n Al</a></li>
                <li><a href="notpaylas.html">Not PaylaÅŸ</a></li> 
                <li><button id="logoutBtn" style="background:none; border:none; color:red; font-weight:600; cursor:pointer;">Ã‡Ä±kÄ±ÅŸ Yap</button></li>
            </ul>
            <div class="hamburger">
                <i class="fa-solid fa-bars"></i>
            </div>
        </div>
    </nav>

    <section class="dashboard-section">
        <div class="container">
            
            <div class="dashboard-header">
                <div class="welcome-text">
                    <h1>HoÅŸgeldin, <span id="userNameDisplay">YÃ¼kleniyor...</span> ðŸ‘‹</h1>
                    <p id="userUniDisplay" style="color:#666; font-size:0.9rem;">...</p>
                </div>
                
                <div class="wallet-card">
                    <div class="card-content">
                        <span>Toplam Bakiye</span>
                        <h2 id="userBalance">â‚º ...</h2>
                        <div class="card-actions">
                            <button class="btn-wallet btn-withdraw"><i class="fa-solid fa-arrow-up-from-bracket"></i> Ã‡ek</button>
                            <button class="btn-wallet btn-deposit"><i class="fa-solid fa-plus"></i> YÃ¼kle</button>
                        </div>
                    </div>
                    <div class="card-decoration">
                        <i class="fa-solid fa-wallet"></i>
                    </div>
                </div>
            </div>

            <div class="transactions-panel">
                <h3>Son Ä°ÅŸlemler</h3>
                <div class="table-responsive">
                    <table class="transaction-table">
                        <thead>
                            <tr>
                                <th>Ä°ÅŸlem AdÄ±</th>
                                <th>Tarih</th>
                                <th>Durum</th>
                                <th>Tutar</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsBody">
                            <tr>
                                <td colspan="4" style="text-align:center; padding:20px; color:#999;">
                                    Veriler yÃ¼kleniyor...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="transactions-panel" style="margin-top: 30px;">
                <h3>ðŸ“š KÃ¼tÃ¼phanem (SatÄ±n AldÄ±klarÄ±m)</h3>
                <div class="table-responsive">
                    <table class="transaction-table">
                        <thead>
                            <tr>
                                <th>Ders AdÄ±</th>
                                <th>SatÄ±n Alma Tarihi</th>
                                <th>Ä°ÅŸlem</th>
                            </tr>
                        </thead>
                        <tbody id="libraryBody">
                            <tr>
                                <td colspan="3" style="text-align:center; padding:20px; color:#999;">
                                    KÃ¼tÃ¼phane yÃ¼kleniyor...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </section>

    <footer>
        <div class="container footer-content">
            <div class="footer-brand">
                <h2>UniNot</h2>
                <p>Ã–ÄŸrencilerin dijital kÃ¼tÃ¼phanesi.</p>
            </div>
            <div class="copyright">
                <p>&copy; 2025 UniNot.</p>
            </div>
        </div>
    </footer>

    <script src="script.js"></script>

    <script type="module">
        import { supabase } from './supabase.js';

        const userNameDisplay = document.getElementById('userNameDisplay');
        const userUniDisplay = document.getElementById('userUniDisplay');
        const userBalance = document.getElementById('userBalance');
        const transactionsBody = document.getElementById('transactionsBody');
        const libraryBody = document.getElementById('libraryBody');

        async function loadUserData() {
            // 1. GiriÅŸ Yapan KullanÄ±cÄ±yÄ± Bul
            const { data: { user } } = await supabase.auth.getUser();

            if (!user) {
                window.location.href = "Kayit.html";
                return;
            }

            // 2. Profil DetaylarÄ±nÄ± Ã‡ek (Ä°sim, Okul, Bakiye)
            const { data: profile, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', user.id)
                .single();

            if (profile) {
                userNameDisplay.innerText = profile.full_name || user.email.split('@')[0];
                userUniDisplay.innerText = (profile.university && profile.department) 
                    ? `${profile.university} - ${profile.department}` 
                    : "Profil bilgileri eksik.";
                
                const balance = profile.credits ? profile.credits : 0;
                userBalance.innerText = `â‚º ${parseFloat(balance).toFixed(2)}`;
            }

            // 3. Ä°ÅžLEM GEÃ‡MÄ°ÅžÄ°NÄ° Ã‡EK (Transactions Tablosu)
            const { data: transactions } = await supabase
                .from('transactions')
                .select('*')
                .eq('buyer_id', user.id)
                .order('created_at', { ascending: false });

            if (transactions && transactions.length > 0) {
                transactionsBody.innerHTML = "";
                transactions.forEach(tx => {
                    const title = tx.note_name || 'Bakiye YÃ¼kleme';
                    // Note ID null ise para yÃ¼klemedir (+), doluysa harcamadÄ±r (-)
                    const isDeposit = tx.note_id === null; 
                    
                    const row = `
                        <tr>
                            <td>
                                <div class="trans-info">
                                    <div class="icon-circle ${isDeposit ? 'income' : 'expense'}">
                                        <i class="fa-solid ${isDeposit ? 'fa-wallet' : 'fa-file-pdf'}"></i>
                                    </div>
                                    <span>${title}</span>
                                </div>
                            </td>
                            <td>${new Date(tx.created_at).toLocaleDateString('tr-TR')}</td>
                            <td><span class="badge-success">TamamlandÄ±</span></td>
                            <td class="${isDeposit ? 'amount-plus' : 'amount-minus'}">
                                ${isDeposit ? '+' : '-'} â‚º${tx.amount}
                            </td>
                        </tr>
                    `;
                    transactionsBody.innerHTML += row;
                });
            } else {
                transactionsBody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">HenÃ¼z bir iÅŸlem yok.</td></tr>';
            }

            // 4. KÃœTÃœPHANEMÄ° Ã‡EK (SatÄ±n alÄ±nan notlar ve indirme linkleri)
            // Transactions tablosunu Notes tablosuyla birleÅŸtirip URL'i alÄ±yoruz
            const { data: myLibrary } = await supabase
                .from('transactions')
                .select('created_at, note_name, notes(file_url)')
                .eq('buyer_id', user.id)
                .not('note_id', 'is', null) // Sadece not satÄ±n alÄ±mlarÄ±nÄ± getir
                .order('created_at', { ascending: false });

            if (myLibrary && myLibrary.length > 0) {
                libraryBody.innerHTML = "";
                myLibrary.forEach(item => {
                    // Not silinmiÅŸse link Ã§alÄ±ÅŸmaz, kontrol edelim
                    const fileUrl = item.notes ? item.notes.file_url : '#';
                    const linkStyle = item.notes ? "color:#4f46e5; cursor:pointer;" : "color:gray; cursor:not-allowed;";
                    const linkText = item.notes ? '<i class="fa-solid fa-download"></i> Ä°ndir' : 'Not SilinmiÅŸ';

                    const row = `
                        <tr>
                            <td style="font-weight:500;">${item.note_name}</td>
                            <td>${new Date(item.created_at).toLocaleDateString('tr-TR')}</td>
                            <td>
                                <a href="${fileUrl}" target="_blank" style="${linkStyle} font-weight:bold; text-decoration:none;">
                                    ${linkText}
                                </a>
                            </td>
                        </tr>
                    `;
                    libraryBody.innerHTML += row;
                });
            } else {
                libraryBody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;">HenÃ¼z satÄ±n alÄ±nan not yok.</td></tr>';
            }
        }

        loadUserData();

        // Ã‡Ä±kÄ±ÅŸ Yap Butonu
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await supabase.auth.signOut();
            window.location.href = "index.html";
        });
    </script>
</body>
</html>